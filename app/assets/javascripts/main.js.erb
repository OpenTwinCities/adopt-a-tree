$(function() {
  var activeThingId;
  var activeMarker;
  var activeInfoWindow;
  var isWindowOpen = false;

  function insertFormErrors(form_name, form_prefix, data, errors){
    for (var attribute in data.errors){
      errors.push($('#'+form_prefix+'_'+attribute));
      $('#'+form_prefix+'_'+attribute).parent().addClass('error');
      var error_msg = $('<span>');
      error_msg.attr('id', form_prefix+'_'+attribute+'_errormsg');
      error_msg.addClass('errormsg');
      error_msg.text('-- '+ data.errors[attribute].join() +' --');
      $('#'+form_prefix+'_'+attribute).after(error_msg);

    };

    $('html, body').animate({
      scrollTop: ($('#'+form_name+' .error').first().offset().top)
    }, 500);
    //errors[0].focus();
  }

  function congratulateAdopter(args){
    $.ajax({
      type: 'GET',
      url: '/info_window',
      data: {
        'thing_id': args.activeThingId,
        'flash': {
          'notice': "<%= I18n.t("notices.adopted", thing: I18n.t("defaults.thing")) %>"
        }
      },
      success: function(data) {
        congrats_content = $("<div>").html(data)
        args.activeInfoWindow.close();
        args.activeInfoWindow.setContent(data);
        args.activeInfoWindow.open(map, args.activeMarker);
        args.activeMarker.setIcon(ThingMap.greenMarkerImage);
        args.activeMarker.setAnimation(google.maps.Animation.BOUNCE);
    	  $('#edit_profile_link').click();
      }
    });
  }

  function askForToken(args, callback){
    $.ajax({
      type: 'GET',
      url: '/promo_codes/use',
      success: function(data) {
        ask_for_token_content = $("<div>").html(data)
        token_input_container = $("<div>").html(ask_for_token_content.find("#token_input_container"));
        token_possession_container = $("<div>").html(ask_for_token_content.find("#token_possession_container"));
        ask_for_token_content.find("#token_container").html(token_possession_container.html());
        args.activeInfoWindow.close();
        args.activeInfoWindow.setContent(ask_for_token_content.html());
        args.activeInfoWindow.open(map, args.activeMarker);
      }
    });

  }

  $('#combo-form').on('submit', function() {
    var submitButton = $("#combo-form input[type='submit']");
    $(submitButton).attr("disabled", true);
    $('#combo-form .errormsg').remove();
    $('#combo-form .error').removeClass('error');
    var errors = [];
    if(!/[\w\.%\+]+@[\w]+\.+[\w]{2,}/.test($('#user_email').val())) {
      <%#errors.push($('#user_email'));%>
      $('#user_email').parent().addClass('error');
    } else {
      $('#user_email').parent().removeClass('error');
    }
    if(!$(this).data('state') || $(this).data('state') === 'user_sign_up') {
      if($('#user_username').val() === '') {
        errors.push($('#user_username'));
        $('#user_username').parent().addClass('error');
      } else {
        $('#user_username').parent().removeClass('error');
      }
      if($('#user_password_confirmation').val().length < 6 || $('#user_password_confirmation').val().length > 20) {
        errors.push($('#user_password_confirmation'));
        $('#user_password_confirmation').parent().addClass('error');
      } else {
        $('#user_password_confirmation').parent().removeClass('error');
      }
      if(errors.length > 0) {
        $(submitButton).attr("disabled", false);
        errors[0].focus();
      } else {
        $.ajax({
          type: 'POST',
          url: '/users.json',
          data: {
            'utf8': '✓',
            'authenticity_token': $('#combo-form input[name="authenticity_token"]').val(),
            'user': {
              'email': $('#user_email').val(),
              'username': $('#user_username').val(),
              'first_name': $('#user_first_name').val(),
              'last_name': $('#user_last_name').val(),
              'organization': $('#user_organization').val(),
              'address_1': $('#user_address_1').val(),
              'address_2': $('#user_address_2').val(),
              'city': $('#user_city').val(),
              'state': $('#user_state').val(),
              'zip': $('#user_zip').val(),
              'voice_number': $('#user_voice_number').val(),
              'sms_number': $('#user_sms_number').val(),
              'password': $('#user_password_confirmation').val(),
              'password_confirmation': $('#user_password_confirmation').val()
            }
          },
          error: function(jqXHR) {
            var data = $.parseJSON(jqXHR.responseText);
            $(submitButton).attr("disabled", false);

            insertFormErrors('combo-form', 'user', data, errors);
          },
          success: function(data) {
            $.ajax({
              type: 'GET',
              url: '/sidebar/search',
              data: {
                'flash': {
                  'notice': "<%= I18n.t("notices.signed_up") %>"
                }
              },
              success: function(data) {
                $('#content').html(data);
              }
            });
          }
        });
      }
    } else if($(this).data('state') === 'user_sign_in') {
      if($('#user_password').val().length < 6 || $('#user_password').val().length > 20) {
        errors.push($('#user_password'));
        $('#user_password').parent().addClass('error');
      } else {
        $('#user_password').parent().removeClass('error');
      }
      if(errors.length > 0) {
        $(submitButton).attr("disabled", false);
        errors[0].focus();
      } else {
        $.ajax({
          type: 'POST',
          url: '/users/sign_in.json',
          data: {
            'utf8': '✓',
            'authenticity_token': $('#combo-form input[name="authenticity_token"]').val(),
            'user': {
              'email': $('#user_email').val(),
              'password': $('#user_password').val(),
              'remember_me': $('#user_remember_me').val()
            }
          },
          error: function(jqXHR) {
            $(submitButton).attr("disabled", false);
            $('#user_password').parent().addClass('error');
            $('#user_password').focus();
          },
          success: function(data) {
            $.ajax({
              type: 'GET',
              url: '/sidebar/search',
              data: {
                'flash': {
                  'notice': "<%= I18n.t("notices.signed_in") %>"
                }
              },
              success: function(data) {
                $('#content').html(data);
              }
            });
          }
        });
      }
    } else if($(this).data('state') === 'user_forgot_password') {
      if(errors.length > 0) {
        $(submitButton).attr("disabled", false);
        errors[0].focus();
      } else {
        $.ajax({
          type: 'POST',
          url: '/users/password.json',
          data: {
            'utf8': '✓',
            'authenticity_token': $('#combo-form input[name="authenticity_token"]').val(),
            'user': {
              'email': $('#user_email').val()
            }
          },
          error: function(jqXHR) {
            $(submitButton).attr("disabled", false);
            $('#user_email').parent().addClass('error');
            $('#user_email').focus();
          },
          success: function() {
            $(submitButton).attr("disabled", false);
            $('#user_remembered_password_link').click();
            $('#user_password').focus();
          }
        });
      }
    }
    return false;
  });

  $('#adoption_form').on('submit', function() {
    var submitButton = $("#adoption_form input[type='submit']");
    $(submitButton).attr("disabled", true);
    $.ajax({
      type: 'POST',
      url: '/things.json',
      data: {
        '_method': 'patch',
        'id': $('#thing_id').val(),
        'utf8': '✓',
        'authenticity_token': $('#adoption_form input[name="authenticity_token"]').val(),
        'thing': {
          'user_id': $('#thing_user_id').val(),
          'name': $('#thing_name').val()
        }
      },
      error: function(jqXHR) {
        $(submitButton).attr("disabled", false);
      },
      success: function(data) {
        active_things = {
          activeThingId: activeThingId,
          activeInfoWindow: activeInfoWindow,
          activeMarker: activeMarker
        };
        congratulateAdopter(active_things);
      }
    });
    return false;
  });

  $('#token_code_no').on('click', function(e){
    e.preventDefault();
    active_things = {
      activeThingId: activeThingId,
      activeInfoWindow: activeInfoWindow,
      activeMarker: activeMarker
    };
    congratulateAdopter(active_things);
  });

  $('#token_code_yes').on('click', function(e){
    e.preventDefault();
    ask_for_token_content.find("#token_container").html(token_input_container.html())
    activeInfoWindow.close();
    activeInfoWindow.setContent(ask_for_token_content.html());
    activeInfoWindow.open(map, activeMarker);
  });

  $("#promo_code_form").on('submit', function(e){
    e.preventDefault();
    $.ajax({
      type: 'POST',
      url: '/promo_codes',
      data: {
        '_method': 'patch',
        'utf8': '✓',
        'authenticity_token': $('#promo_code_form input[name="authenticity_token"]').val(),
        'promo_code': {
          'user_id': $('#promo_code_user_id').val(),
          'token': $('#promo_code_token_code').val()
        }
      },
      error: function(jqXHR) {
        activeInfoWindow.close();
        if(jqXHR.status == '404'){
	  err_msg = 'Promo Code Not Found';
        } else {
          err_msg = jqXHR.responseText;
        }
        err_msg_el = $('<div><div class="alert alert-error fade in"><p></p></div></div>');
        err_msg_el.find(".alert p").html(err_msg);
        activeInfoWindow.setContent(err_msg_el.html());
        activeInfoWindow.open(map, activeMarker);
      },
      success: function(data){
        active_things = {
          activeThingId: activeThingId,
          activeInfoWindow: activeInfoWindow,
          activeMarker: activeMarker
        };
        congratulateAdopter(active_things);
      }
    });
  });

  $('#abandon_form').on('submit', function() {
    var answer = window.confirm("Are you sure you want to abandon this <%= I18n.t("defaults.thing") %>?")
    if(answer) {
      var submitButton = $("#abandon_form input[type='submit']");
      $(submitButton).attr("disabled", true);
      $.ajax({
        type: 'POST',
        url: '/things.json',
        data: {
          '_method': 'patch',
          'id': $('#thing_id').val(),
          'utf8': '✓',
          'authenticity_token': $('#abandon_form input[name="authenticity_token"]').val(),
          'thing': {
            'user_id': $('#thing_user_id').val(),
            'name': $('#thing_name').val()
          }
        },
        error: function(jqXHR) {
          $(submitButton).attr("disabled", false);
        },
        success: function(data) {
          $.ajax({
            type: 'GET',
            url: '/info_window',
            data: {
              'thing_id': activeThingId,
              'flash': {
                'warning': "<%= I18n.t("notices.abandoned", thing: I18n.t("defaults.thing").capitalize) %>"
              }
            },
            success: function(data) {
              activeInfoWindow.close();
              activeInfoWindow.setContent(data);
              activeInfoWindow.open(map, activeMarker);
              activeMarker.setIcon(ThingMap.redMarkerImage);
              activeMarker.setAnimation(null);
            }
          });
        }
      });
    }
    return false;
  });

  $('#edit_profile_link').on('click', function() {
    var link = $(this);
    $(link).addClass('disabled');
    $.ajax({
      type: 'GET',
      url: '/users/edit',
      error: function(jqXHR) {
        $(link).removeClass('disabled');
      },
      success: function(data) {
        $('#content').html(data);
      }
    });
    return false;
  });

  $('#edit_form').on('submit', function() {
    var submitButton = $("#edit_form input[type='submit']");
    $(submitButton).attr("disabled", true);
    $('#edit_form .errormsg').remove();
    $('#edit_form .error').removeClass('error');
    var errors = []
    if(!/[\w\.%\+\]+@[\w\]+\.+[\w]{2,}/.test($('#user_email').val())) {
      errors.push($('#user_email'));
      $('#user_email').parent().addClass('error');
    } else {
      $('#user_email').parent().removeClass('error');
    }
    if($('#user_username').val() === '') {
      errors.push($('#user_username'));
      $('#user_username').parent().addClass('error');
    } else {
      $('#user_username').parent().removeClass('error');
    }
    if($('#user_zip').val() != '' && !/^\d{5}(-\d{4})?$/.test($('#user_zip').val())) {
      errors.push($('#user_zip'));
      $('#user_zip').parent().addClass('error');
    } else {
      $('#user_zip').parent().removeClass('error');
    }
    if($('#user_password').val() && ($('#user_password').val().length < 6 || $('#user_password').val().length > 20)) {
      errors.push($('#user_password'));
      $('#user_password').parent().addClass('error');
    } else {
      $('#user_password').parent().removeClass('error');
    }
    if($('#user_current_password').val().length < 6 || $('#user_current_password').val().length > 20) {
      errors.push($('#user_current_password'));
      $('#user_current_password').parent().addClass('error');
    } else {
      $('#user_current_password').parent().removeClass('error');
    }
    if(errors.length > 0) {
      $(submitButton).attr("disabled", false);
      errors[0].focus();
    } else {
      $.ajax({
        type: 'POST',
        url: '/users.json',
        data: {
          '_method': 'patch',
          'id': $('#id').val(),
          'thing_id': activeThingId,
          'utf8': '✓',
          'authenticity_token': $('#edit_form input[name="authenticity_token"]').val(),
          'user': {
            'email': $('#user_email').val(),
            'username': $('#user_username').val(),
            'first_name': $('#user_first_name').val(),
            'last_name': $('#user_last_name').val(),
            'organization': $('#user_organization').val(),
            'voice_number': $('#user_voice_number').val(),
            'sms_number': $('#user_sms_number').val(),
            'address_1': $('#user_address_1').val(),
            'address_2': $('#user_address_2').val(),
            'city': $('#user_city').val(),
            'state': $('#user_state').val(),
            'zip': $('#user_zip').val(),
            'yob': $('#user_yob').val(),
            'gender': $('input[name="user[gender]"]:checked', '#edit_form').val(),
            'ethnicity': $("input[name='user[ethnicity][]']:checked").map(function(){return this.value;}).get(),
            'heardOfAdoptATreeVia': $("input[name='user[heardOfAdoptATreeVia][]']:checked").map(function(){return this.value;}).get(),
            'yearsInMinneapolis': $('#user_yearsInMinneapolis').val(),
            'rentOrOwn': $('input[name="user[rentOrOwn]"]:checked', '#edit_form').val(),
            'previousTreeWateringExperience': $('input[name="user[previousTreeWateringExperience]"]:checked', '#edit_form').val(),
            'previousEnvironmentalActivities': $('input[name="user[previousEnvironmentalActivities]"]:checked', '#edit_form').val(),
            'valueForestryWork': $('input[name="user[valueForestryWork]"]:checked', '#edit_form').val(),
            'password': $('#user_password').val(),
            'password_confirmation': $('#user_password').val(),
            'current_password': $('#user_current_password').val()
          }
        },
        error: function(jqXHR) {
          var data = $.parseJSON(jqXHR.responseText);
          $(submitButton).attr("disabled", false);

          insertFormErrors('edit_form', 'user', data, errors);
        },
        success: function(data) {
          $('#content').html(data);
        }
      });
    }
    return false;
  });

  $('#sign_out_link').on('click', function() {
    var link = $(this);
    $(link).addClass('disabled');
    $.ajax({
      type: 'DELETE',
      url: '/users/sign_out.json',
      error: function(jqXHR) {
        $(link).removeClass('disabled');
      },
      success: function(data) {
        $.ajax({
          type: 'GET',
          url: '/sidebar/combo_form',
          data: {
            'flash': {
              'warning': "<%= I18n.t("notices.signed_out") %>"
            }
          },
          success: function(data) {
            $('#content').html(data);
          }
        });
      }
    });
    return false;
  });

  $('#sign_in_form').on('submit', function() {
    var submitButton = $("#sign_in_form input[type='submit']");
    $(submitButton).attr("disabled", true);
    $.ajax({
      type: 'GET',
      url: '/users/sign_in',
      error: function(jqXHR) {
        $(submitButton).attr("disabled", false);
      },
      success: function(data) {
        activeInfoWindow.close();
        activeInfoWindow.setContent(data);
        activeInfoWindow.open(map, activeMarker);
      }
    });
    return false;
  });

  $('#back_link').on('click', function() {
    var link = $(this);
    $(link).addClass('disabled');
    $.ajax({
      type: 'GET',
      url: '/sidebar/search',
      error: function(jqXHR) {
        $(link).removeClass('disabled');
      },
      success: function(data) {
        $('#content').html(data);
      }
    });
    return false;
  });

  $('.alert-message').alert();

  ThingMap.initialize();
});
